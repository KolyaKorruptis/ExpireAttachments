<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>Suki:ExpireAttachments</id>
	<version>1.0</version>

	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[a.id_attach, a.id_folder, a.id_msg, a.filename, a.file_hash, IFNULL(a.size, 0) AS filesize, a.downloads, a.approved,]]></search>
			<add><![CDATA[a.id_attach, a.id_folder, a.id_msg, a.filename, a.file_hash, IFNULL(a.size, 0) AS filesize, a.downloads, a.approved, a.expire_date,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['is_approved' => $attachment['approved'],]]></search>
			<add><![CDATA['is_approved' => $attachment['approved'],
				'expire_date' => (!empty($attachment['expire_date']) ? $txt['ExAt_ui_showDate'] . expire_attachments_timeElapsed($attachment['expire_date']) : ''),]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[// How much are we sticking on each page?]]></search>
			<add><![CDATA[// Expire Attachments mod
	loadLanguage('ExpireAttachments');
	require_once($sourcedir .'/ExpireAttachments.php');
	// Expire Attachments mod

	// How much are we sticking on each page?]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Post.php">
		<operation>
			<search position="replace"><![CDATA[$context['can_post_attachment_unapproved'] = allowedTo('post_attachment');]]></search>
			<add><![CDATA[$context['can_post_attachment_unapproved'] = allowedTo('post_attachment');

	// Expire Attachments mod
	loadLanguage('ExpireAttachments');
	$context['ExAt_list'] = '';

	if (!empty($modSettings['ExAt_setting_enable']))
	{
		$context['ExAt_list'] .= '<select name="expire_date0" id="expire_date1">';

		// Set the hardcoded periods
		$context['ExAt_periods'] = array('Day', 'Week', 'Month', 'Year');
		$context['ExAt_availableOptions'] = array();

		// Add each option if the user has the permission to use it
		foreach  ($context['ExAt_periods'] as $period)
			if (!empty($modSettings['ExAt_setting_enable'. $period .'_period']))
			{
				$context['ExAt_availableOptions'][] = $period;
				if (allowedTo('ExAt_'. $period))
					$context['ExAt_list'] .= '<option value="'. $period .'">'. $modSettings['ExAt_setting_periods_number'] .' '. $period .'</option>';
			}

		// Close the list
		$context['ExAt_list'] .= '</select>';
	}
	// Expire Attachments mod end]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[if (createAttachment($attachmentOptions))]]></search>
			<add><![CDATA[// Expire Attachments mod
			if (!empty($modSettings['ExAt_setting_enable']) && !empty($_REQUEST['expire_date'. $n]))
			{
				// Set the var
				$attachmentOptions['expire_date'] = 0;

				// One last extra check, just to be sure...
				if (empty($modSettings['ExAt_setting_periods_number']))
					$modSettings['ExAt_setting_periods_number'] = 1;

				// Calculate the time ahead, strtotime() makes things easy, for me, not the server...
				$expire_date = strtotime('+'. $modSettings['ExAt_setting_periods_number'] .' '. strtolower($_REQUEST['expire_date'. $n]));

				// Fill up the var
				if (!empty($expire_date))
					$attachmentOptions['expire_date'] = (int) $expire_date;
			}
			// Expire Attachments mod end

			if (createAttachment($attachmentOptions))]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Post.php">
		<operation>
			<search position="replace"><![CDATA[array(
					'id_folder' => 'int', 'id_msg' => 'int', 'attachment_type' => 'int', 'filename' => 'string-255', 'file_hash' => 'string-40', 'fileext' => 'string-8',
					'size' => 'int', 'width' => 'int', 'height' => 'int', 'mime_type' => 'string-20', 'approved' => 'int',
				),]]></search>
			<add><![CDATA[array(
					'id_folder' => 'int', 'id_msg' => 'int', 'attachment_type' => 'int', 'filename' => 'string-255', 'file_hash' => 'string-40', 'fileext' => 'string-8',
					'size' => 'int', 'width' => 'int', 'height' => 'int', 'mime_type' => 'string-20', 'approved' => 'int', 'expire_date' => 'int',
				),]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[array(
					$id_folder, (int) $attachmentOptions['post'], 3, $thumb_filename, $thumb_file_hash, $attachmentOptions['fileext'],
					$thumb_size, $thumb_width, $thumb_height, $thumb_mime, (int) $attachmentOptions['approved'],
				),]]></search>
			<add><![CDATA[array(
					$id_folder, (int) $attachmentOptions['post'], 3, $thumb_filename, $thumb_file_hash, $attachmentOptions['fileext'],
					$thumb_size, $thumb_width, $thumb_height, $thumb_mime, (int) $attachmentOptions['approved'], (int) $attachmentOptions['expire_date'],
				),]]></add>
		</operation>
	</file>

	<file name="$themedir/Post.template.php">
		<operation>
			<search position="replace"><![CDATA[// Show more boxes only if they aren't approaching their limit.]]></search>
			<add><![CDATA[// Expire Attachments mod
		if (!empty($modSettings['ExAt_setting_enable']))
			echo $txt['ExAt_ui_title'] . $context['ExAt_list'];
		// Expire Attachments mod end

		// Show more boxes only if they aren't approaching their limit.]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[function addAttachment()
								{
									allowed_attachments = allowed_attachments - 1;
									current_attachment = current_attachment + 1;
									if (allowed_attachments <= 0)
										return alert("', $txt['more_attachments_error'], '");

									setOuterHTML(document.getElementById("moreAttachments"), \'<dd class="smalltext"><input type="file" size="60" name="attachment[]" id="attachment\' + current_attachment + \'" class="input_file" /> (<a href="javascript:void(0);" onclick="cleanFileInput(\\\'attachment\' + current_attachment + \'\\\');">', $txt['clean_attach'], '</a>)\' + \'</dd><dd class="smalltext" id="moreAttachments"><a href="#" onclick="addAttachment(); return false;">(', $txt['more_attachments'], ')<\' + \'/a><\' + \'/dd>\');

									return true;
								}]]></search>
			<add><![CDATA[function addAttachment()
								{
									allowed_attachments = allowed_attachments - 1;
									current_attachment = current_attachment + 1;
									var current_Select = current_attachment - 1;
									if (allowed_attachments <= 0)
										return alert("', $txt['more_attachments_error'], '");

									setOuterHTML(document.getElementById("moreAttachments"), \'<dd class="smalltext"><input type="file" size="60" name="attachment[]" id="attachment\' + current_attachment + \'" class="input_file" /> (<a href="javascript:void(0);" onclick="cleanFileInput(\\\'attachment\' + current_attachment + \'\\\');">', $txt['clean_attach'], '</a>)';

			// Expire Attachments mod
			echo '\' + \'', $txt['ExAt_ui_title'] ,'<select name="expire_date\' + current_Select + \'" id="expire_date\' + current_attachment + \'">';

			foreach ($context['ExAt_availableOptions'] as $period)
				echo '\' + \'<option value="', $period ,'">', $modSettings['ExAt_setting_periods_number'] ,' ', $period ,'</option>';

			echo '\' + \'</select>';
			// Expire Attachments mod end

			echo'\' + \'</dd><dd class="smalltext" id="moreAttachments"><a href="#" onclick="addAttachment(); return false;">(', $txt['more_attachments'], ')<\' + \'/a><\' + \'/dd>\');

									return true;
								}]]></add>
		</operation>
	</file>

	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[(', $attachment['size'], ($attachment['is_image'] ? ', ' . $attachment['real_width'] . 'x' . $attachment['real_height'] . ' - ' . $txt['attach_viewed'] : ' - ' . $txt['attach_downloaded']) . ' ' . $attachment['downloads'] . ' ' . $txt['attach_times'] . '.)<br />';]]></search>
			<add><![CDATA[(', $attachment['size'], ($attachment['is_image'] ? ', ' . $attachment['real_width'] . 'x' . $attachment['real_height'] . ' - ' . $txt['attach_viewed'] : ' - ' . $txt['attach_downloaded']) . ' ' . $attachment['downloads'] . ' ' . $txt['attach_times'] . '.)';

				// Expire Attachments mod
				if (!empty($modSettings['ExAt_setting_enable']) && !empty($attachment['expire_date']))
					echo '
										', $attachment['expire_date'];

				echo '
										<br />';
				// Expire Attachments mod]]></add>
		</operation>
	</file>

</modification>