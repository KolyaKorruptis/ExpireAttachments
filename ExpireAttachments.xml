<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>Suki:ExpireAttachments</id>
	<version>1.0</version>

	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[a.id_attach, a.id_folder, a.id_msg, a.filename, a.file_hash, IFNULL(a.size, 0) AS filesize, a.downloads, a.approved,]]></search>
			<add><![CDATA[a.id_attach, a.id_folder, a.id_msg, a.filename, a.file_hash, IFNULL(a.size, 0) AS filesize, a.downloads, a.approved, a.expire_date,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['is_approved' => $attachment['approved'],]]></search>
			<add><![CDATA['is_approved' => $attachment['approved'],
				'expire_date' => $attachment['expire_date'],]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[]]></search>
			<add><![CDATA[]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[]]></search>
			<add><![CDATA[]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[]]></search>
			<add><![CDATA[]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Post.php">
		<operation>
			<search position="replace"><![CDATA[$context['can_post_attachment_unapproved'] = allowedTo('post_attachment');]]></search>
			<add><![CDATA[$context['can_post_attachment_unapproved'] = allowedTo('post_attachment');

	// Expire Attachments mod
	loadLanguage('ExpireAttachments');
	$context['ExAt_list'] = '';

	if (!empty($modSettings['ExAt_setting_enable']))
	{
		$context['ExAt_list'] .= '<select name="expire_date">';

		// Set the hardcoded periods
		$ExAt_periods = array('Day', 'Week', 'Month', 'Year');

		// Add each option if the user has the permission to use it
		foreach  ($ExAt_periods as $period)
			if (!empty($modSettings['ExAt_setting_enable'. $period .'_period']))
				if (allowedTo('ExAt_'. $period))
					$context['ExAt_list'] .= '<option value="'. $period .'">'. $modSettings['ExAt_setting_periods_number'] .' '. $period .'</option>';

		// Close the list
		$context['ExAt_list'] .= '</select>';
	}
	// Expire Attachments mod end]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[if (createAttachment($attachmentOptions))]]></search>
			<add><![CDATA[// Expire Attachments mod
			if (!empty($modSettings['ExAt_setting_enable']) && !empty(trim($_POST['expire_date'])))
			{
				// Set the var
				$attachmentOptions['expire_date'] = 0;

				// One last extra check, just to be sure...
				if (empty($modSettings['ExAt_setting_periods_number']))
					$modSettings['ExAt_setting_periods_number'] = 1;

				// Calculate the time ahead, strtotime() makes things easy, for me, not the server...
				$expire_date = strtotime('+'. $modSettings['ExAt_setting_periods_number'] .' '. strtolower($_POST['expire_date']));

				// Fill up the var
				if (!empty($expire_date))
					$attachmentOptions['expire_date'] = (int) $expire_date;
			}
			// Expire Attachments mod end]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Post.php">
		<operation>
			<search position="replace"><![CDATA[$smcFunc['db_insert']('',
		'{db_prefix}attachments',
		array(
			'id_folder' => 'int', 'id_msg' => 'int', 'filename' => 'string-255', 'file_hash' => 'string-40', 'fileext' => 'string-8',
			'size' => 'int', 'width' => 'int', 'height' => 'int',
			'mime_type' => 'string-20', 'approved' => 'int',
		),
		array(
			$id_folder, (int) $attachmentOptions['post'], $attachmentOptions['name'], $attachmentOptions['file_hash'], $attachmentOptions['fileext'],
			(int) $attachmentOptions['size'], (empty($attachmentOptions['width']) ? 0 : (int) $attachmentOptions['width']), (empty($attachmentOptions['height']) ? '0' : (int) $attachmentOptions['height']),
			(!empty($attachmentOptions['mime_type']) ? $attachmentOptions['mime_type'] : ''), (int) $attachmentOptions['approved'],
		),
		array('id_attach')
	);]]></search>
			<add><![CDATA[$smcFunc['db_insert']('',
		'{db_prefix}attachments',
		array(
			'id_folder' => 'int', 'id_msg' => 'int', 'filename' => 'string-255', 'file_hash' => 'string-40', 'fileext' => 'string-8',
			'size' => 'int', 'width' => 'int', 'height' => 'int',
			'mime_type' => 'string-20', 'approved' => 'int', 'expire_date' => 'int',
		),
		array(
			$id_folder, (int) $attachmentOptions['post'], $attachmentOptions['name'], $attachmentOptions['file_hash'], $attachmentOptions['fileext'],
			(int) $attachmentOptions['size'], (empty($attachmentOptions['width']) ? 0 : (int) $attachmentOptions['width']), (empty($attachmentOptions['height']) ? '0' : (int) $attachmentOptions['height']),
			(!empty($attachmentOptions['mime_type']) ? $attachmentOptions['mime_type'] : ''), (int) $attachmentOptions['approved'], (int) $attachmentOptions['expire_date'],
		),
		array('id_attach')
	);]]></add>
		</operation>
	</file>

	<file name="$themedir/Post.template.php">
		<operation>
			<search position="replace"><![CDATA[// Show more boxes only if they aren't approaching their limit.]]></search>
			<add><![CDATA[// Expire Attachments mod
		if (!empty($modSettings['ExAt_setting_enable']))
			echo $txt['ExAt_ui_title'] . $context['ExAt_list'];
		// Expire Attachments mod end

		// Show more boxes only if they aren't approaching their limit.]]></add>
		</operation>
	</file>

	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[]]></search>
			<add><![CDATA[]]></add>
		</operation>
	</file>

</modification>